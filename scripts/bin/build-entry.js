const fs = require('fs')
const path = require('path')
const render = require('json-templater/string')
const endOfLine = require('os').EOL
const Methods = require('../../methods.json')

const OUTPUT_PATH = path.join(__dirname, '../entry.js')
const IMPORT_TEMPLATE = "import { {{name}} } from '{{path}}'"
const METHODS_TEMPLATE = `/* Automatically generated by '../build/bin/build-entry.js' */

{{include}}

export default {
  version: '{{version}}',
{{list}}
}
`

const MethodsNames = Object.keys(Methods)

const includeMethodsTemplate = []
const listTemplate = []

MethodsNames.forEach((name) => {
  includeMethodsTemplate.push(
    render(IMPORT_TEMPLATE, {
      name,
      path: Methods[name],
    })
  )

  listTemplate.push(`  ${name}`)
})

const template = render(METHODS_TEMPLATE, {
  include: includeMethodsTemplate.join(endOfLine),
  version: process.env.VERSION || require('../../package.json').version,
  list: listTemplate.join(`,${endOfLine}`),
})

fs.writeFileSync(OUTPUT_PATH, template)

console.log('[build entry] DONE:', OUTPUT_PATH)
